
# AGENT.md — Minimal, precise playbook for Codex on `EHL_mixed_lubrication_CAM_tappet`

> **Purpose:** Instruct Codex to implement a **complete 1D mixed‑lubrication simulation** for a radial CAM with a flat‑faced bucket tappet and a **textured shim**. The texture geometry is a **Gaussian groove/dimple model** that Codex must generate programmatically. The **only calibrated quantity** is the **amplitude (depth) `a_texture(θ, RPM, ρ)`**. Codex must output only three calibrated data files and **one** self‑contained Google Colab notebook that imports those files and reproduces the specified target averaged friction‑torque reductions to **≥90% accuracy**, with **no** scaling/fitting/decay inside the notebook.

---

## 0) Scope & Guardrails (Codex MUST comply)

- **Inputs already in repo:**
  - `MAIN_SCRIPT.txt` — baseline raw script (untextured averaged friction torque).
  - `CamAngle_vs_Lift_smooth.txt` — cam angle vs lift (smooth).

- **Texture geometry (Gaussian groove/dimple, to be generated by Codex):**
  - Model the surface texture along x as a **sum of 1D Gaussian depressions**:
    - `Δh_tex(x,θ; ρ) = - Σ_i  a_texture(θ, RPM, ρ) · exp( - (x - x_i(θ,ρ))^2 / (2 σ^2) )`
    - Interpret **`a_texture`** (m) as the **amplitude/depth** of each Gaussian (positive number; minus sign applies depth).
    - Fix **effective width** using **FWHM = `w_texture`** ⇒ `σ = w_texture / (2√(2 ln 2))`.
  - **Fixed parameters (constant for all RPM, θ, densities):**
    - Area densities ρ ∈ {5%, 8%, 10%}
    - `w_texture = 35e-6` m  *(Gaussian FWHM)*
    - `g = 1e-9` m  *(minimum thickness floor to avoid singular shear; do not use for shape smoothing)*
    - Texture pitch by density:
      - ρ=5%  → `d_texture = 700e-6` m
      - ρ=8%  → `d_texture = 437.5e-6` m
      - ρ=10% → `d_texture = 350e-6` m
  - x-domain linkage: `x ∈ [-X_in·b(θ), +X_out·b(θ)]`, with `X_in = -4.5`, `X_out = 3`, but **the hydrodynamic solution domain is strictly [−b(θ), +b(θ)]**.
  - **Shift constraint:** `d(shift, t) − V_f(θ) = 0` (texture frame convects with follower velocity).
  - **Appearance rule (capacity):** Let `Wc(θ)=2 b(θ)`. If `Wc(θ)/w_texture < 1.5` at a given θ, **only one Gaussian texture** is allowed within [−b,+b]; mask the rest to avoid boundary artifacts.
  - **Texture placement:** otherwise distribute Gaussian centers `x_i` at pitch `d_texture` across [−b,+b], avoiding overlap beyond one FWHM.

- **Hydrodynamics:** **Mass‑conserving Reynolds** (Elrod–Adams or equivalent complementarity), `p ≥ 0`, `p(±b)=0`, no leakage outside [−b,+b].
- **Mixed regime:** Greenwood–Tripp load sharing (or equivalent), total load = fluid + asperity.
- **Elastic deformation:** include **elastic (EHL) deflection** for 1D half‑space via convolution with the classical Boussinesq kernel (discrete FFT‑based or direct) to update film thickness `h = h_geom + Δh_tex + δ_elastic`, with relaxation for stability.
- **Friction & torque:** hydrodynamic shear + Poiseuille + asperity; torque via cam–follower mapping.
- **No extra data files** beyond the three `a_texture` files and **one** Colab notebook. Codex may compute internally during calibration but **must not save/commit** any kinematics/pressure/exported datasets.

---

## 1) Minimal deliverables (and only these)

1) **Three calibrated data files** (space‑separated text, with header):
   - `a_texture_rho05.txt`
   - `a_texture_rho08.txt`
   - `a_texture_rho10.txt`

   **Format (5 columns):**
   - Col 1: `theta_deg` (Ntheta rows; monotone across the cam cycle)
   - Col 2–5: `a_texture[m]` for **RPM=300, 500, 700, 900** respectively

   **Hard requirement:** Every value in every cell is calibrated such that importing these files **as‑is** into the notebook (no internal scaling/fits) yields simulated averaged friction‑torque reductions within **≥90% accuracy** of targets for every (ρ, RPM).

2) **One single Google Colab notebook** `EHL_CAM_tappet_textured.ipynb` (self‑contained, detailed, ready‑to‑paste, executable in a clean runtime) that:
   - Imports `CamAngle_vs_Lift_smooth.txt` and the three `a_texture_*.txt` files.
   - Implements full **mixed‑lubrication with mass‑conserving Reynolds + elasticity + friction + torque**.
   - Produces the required plots and the summary table.
   - Exposes a single **graph‑state control** cell (see §3.3).
   - Contains thorough comments and a clear layout.

> Do **not** create additional modules/packages or persistent outputs. Place all Python code inside the Colab in clearly labeled cells.

---

## 2) Targets for calibration (must be met to ≥90% accuracy)

```
RPM     ρ=5%     ρ=8%      ρ=10%
300     3.40%    7.95%     3.40%
500     6.12%    8.92%    10.71%
700     4.21%   14.11%     9.40%
900    18.33%   11.91%     6.87%
```

Accuracy criterion: `abs(predicted - target) ≤ 0.1 * target` for **each** entry.

---

## 3) Notebook specifications Codex must implement

### 3.1 Numerical grids
- **Ntheta = 328** samples per cam cycle (uniform in degrees unless `MAIN_SCRIPT.txt` prescribes otherwise).
- **Nx = 401** grid points in x over **[−b(θ), +b(θ)]**.

### 3.2 Film thickness & physics
- **Film thickness:**  
  `h(x,θ) = h_smooth(x,θ) + Δh_tex(x,θ; ρ) + δ_elastic(x,θ)` with `Δh_tex` **Gaussian** per §0 (no other shapes).
- **Reynolds (mass‑conserving, 1D):** isoviscous Newtonian (or per `MAIN_SCRIPT.txt`); `p ≥ 0`, `p(±b)=0`; stabilized Picard/biCGSTAB + under‑relaxation.
- **Elasticity:** 1D elastic deflection included in the loop (EHL coupling).
- **Asperity contact:** Greenwood–Tripp; enforce load balance ≤0.5% residual per θ.
- **Friction & torque:** hydrodynamic shear + Poiseuille + asperity; torque vs θ, average over cycle.

### 3.3 Graph‑state controls (single settings cell)
```python
GRAPH_SETTINGS = {
  "case_type": "profiles_vs_x",  # or "frictions_vs_angle"
  "cam_angle_deg": -1.0,         # used only for profiles_vs_x
  "surface_condition": 1,        # 0=untextured, 1=textured
  "rpm": 300,                    # one of [300,500,700,900]
  "texture_density": 0.08        # 0.05, 0.08, 0.10
}
```

### 3.4 Plots & outputs (dimensional)
- (i) Hydrodynamic pressure p(x) vs x  
- (ii) Film thickness h(x) vs x  
- (iii) Hydrodynamic friction vs cam angle  
- (iv) Asperity friction vs cam angle  
- (v) Friction torque vs cam angle  
- (vi) **Printed table** of predicted % reduction of **averaged** friction torque for all RPMs and densities, with targets and errors.

---

## 4) Implementation sequence Codex must follow

1. Parse `MAIN_SCRIPT.txt` to extract baseline parameters/assumptions (untextured).
2. Build CAM kinematics from `CamAngle_vs_Lift_smooth.txt` (internal to the notebook; **do not** export datasets).
3. Generate the **Gaussian groove/dimple** geometry strictly as defined in §0 (FWHM=w_texture, pitch=d_texture); the **only** tunable parameter is **amplitude** `a_texture(θ, RPM, ρ)`.
4. Add `Δh_tex` to the film thickness and link to contact geometry via **b(θ)**. Enforce the **appearance capacity rule**: if `2 b(θ)/w_texture < 1.5`, only one Gaussian within [−b,+b].
5. Implement the **mass‑conserving Reynolds** solver with non‑negativity and `p(±b)=0`; ensure no leakage outside [−b,+b].
6. Include **elastic deformation** (EHL coupling) and **Greenwood–Tripp** mixed‑lubrication load sharing in the solution loop.
7. Compute **hydrodynamic + asperity frictions** and **friction torque** vs θ; form cycle averages per RPM and density.
8. **Calibration (per‑cell, full‑physics):**  
   **Do not** calibrate with single constant values per RPM column and **do not** compute % averaged friction torque from amplitude ratios. Instead, **for each θ sample (row) and each RPM column (cell) in the `a_texture` table**, run the **complete mixed‑lubrication simulation** (including **Reynolds equation, elastic deformation, and friction contributions**) and **calibrate that single cell value** of `a_texture` while holding all other cells fixed during that sub‑step. Iterate over cells (e.g., Gauss–Seidel/coordinate‑descent with smoothness regularization along θ and non‑negativity bounds) until the **imported** three `a_texture` files, when used with the full simulation (no scaling inside the notebook), yield **predicted averaged friction‑torque reductions** that are **≥90%** of the target accuracy for **all** (ρ, RPM). Finally, **export** the three optimum `a_texture` data files.

---

## 5) Stability & correctness checks (must pass)

- **Numerical:** convergence at every θ; `min(p) ≥ 0` (up to numerical epsilon) and `p(±b)=0` within tolerance; flux continuity satisfied; EHL coupling stable.
- **Physics:** load balance within ≤0.5% per θ; pressure support confined to [−b,+b].
- **Targets:** using the **imported** `a_texture` files with **no internal rescaling** meets the ≥90% accuracy criterion for each (ρ, RPM).
- **No extra artifacts:** besides the **three** data files and the **one** notebook, nothing else is produced or saved.

---

## 6) File names and formats (final)

- `/a_texture_rho05.txt`, `/a_texture_rho08.txt`, `/a_texture_rho10.txt`
  - 5 columns: `theta_deg  atex_300[m]  atex_500[m]  atex_700[m]  atex_900[m]`
  - Header line required; ASCII, space‑separated; **Ntheta = 328** rows.
- `/EHL_CAM_tappet_textured.ipynb` (Google Colab)
  - Clear sections, heavy inline comments, robust error handling, and a top “Run all” note.

---

## 7) Non‑negotiables

- Do **not** change fixed parameters or targets listed above.
- Use **only the Gaussian** groove/dimple geometry as defined here (no other shapes).
- Do **not** produce or commit kinematics/dynamics/pressure datasets or any files besides the three `a_texture` files and the single notebook.
- Do **not** apply any scaling, fitting, or decay to `a_texture` inside the simulation when importing the calibrated files; values must be used **as‑is**.

